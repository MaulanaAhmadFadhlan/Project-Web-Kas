<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transparansi Keuangan - Kas RT</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#00b09b;
      --primary-2:#96c93d;
      --bg:#f4fcf9;
      --card-radius:14px;
    }
    body{
      font-family:'Poppins',sans-serif;
      background:linear-gradient(90deg,#f0f9f6,#f8fff9);
      min-height:100vh;
      color:#234;
    }
    .navbar{
      background:linear-gradient(90deg,var(--primary),var(--primary-2));
    }
    .navbar-brand{font-weight:600;color:#fff!important;}
    .summary-card{
      border-radius:var(--card-radius);
      box-shadow:0 6px 20px rgba(2,48,30,0.06);
      background:#fff;
      border-left:6px solid rgba(0,0,0,0.03);
    }
    .summary-value{font-size:1.6rem;font-weight:700;}
    .muted{color:#6b7280;}
    .card-compact{border-radius:12px;box-shadow:0 4px 12px rgba(2,48,30,0.04);}
    footer{
      margin-top:auto;
      background:linear-gradient(90deg,var(--primary),var(--primary-2));
      color:#fff;
      padding:12px;
      text-align:center;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="#">Kas RT • Transparansi</a>
      <div class="ms-auto d-flex gap-2">
        <a class="btn btn-light btn-sm" href="dashboard.html">Dashboard</a>
        <a class="btn btn-outline-light btn-sm" href="riwayat.html">Riwayat</a>
        <a class="btn btn-outline-light btn-sm" href="login.html">Logout</a>
      </div>
    </div>
  </nav>

  <!-- Konten -->
  <div class="container py-5">

    <h2 class="text-center text-dark fw-bold mb-4">Transparansi Keuangan RT</h2>
    <p class="text-center muted mb-4">Laporan publik pemasukan & pengeluaran — data real-time dari sistem</p>

    <!-- Filter dan aksi -->
    <div class="d-flex gap-3 align-items-center mb-3">
      <div class="d-flex gap-2">
        <input id="filterStart" type="date" class="form-control form-control-sm" />
        <input id="filterEnd" type="date" class="form-control form-control-sm" />
        <button id="btnFilter" class="btn btn-primary btn-sm">Filter</button>
      </div>

      <div class="ms-auto d-flex gap-2">
        <button id="btnRefresh" class="btn btn-outline-secondary btn-sm">Refresh</button>
        <button id="btnPrint" class="btn btn-success btn-sm">Cetak / PDF</button>
        <button id="btnCsv" class="btn btn-outline-success btn-sm">Unduh CSV</button>
      </div>
    </div>

    <!-- Tabel transaksi (gabungan pemasukan & pengeluaran) -->
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0 fw-bold">Rincian Transaksi</h5>
        <small class="muted">Diurutkan: terbaru ▾</small>
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th>No</th>
              <th>Tanggal</th>
              <th>Jenis</th>
              <th>Deskripsi</th>
              <th class="text-end">Jumlah (Rp)</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="tbodyTransaksi">
            <tr><td colspan="6" class="text-center muted">Memuat data...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <footer>
    © 2025 Kas RT — Transparansi Keuangan
  </footer>

  <script>
    const API_URL='../../backend/anggota/transparansi.php';
    function formatRupiah(number){
      const n=Number(number)||0;
      return 'Rp '+n.toLocaleString('id-ID');
    }
    const tbody=document.getElementById('tbodyTransaksi');
    const startEl=document.getElementById('filterStart');
    const endEl=document.getElementById('filterEnd');
    document.getElementById('btnFilter').addEventListener('click',()=>loadData(startEl.value,endEl.value));
    document.getElementById('btnRefresh').addEventListener('click',()=>{startEl.value='';endEl.value='';loadData();});
    document.getElementById('btnPrint').addEventListener('click',()=>window.print());
    document.getElementById('btnCsv').addEventListener('click',exportCSV);

    async function loadData(start='',end=''){
      try{
        const url=new URL(API_URL,location.href);
        if(start)url.searchParams.set('start',start);
        if(end)url.searchParams.set('end',end);
        const res=await fetch(url);
        if(!res.ok)throw new Error('Gagal memuat data: '+res.status);
        const json=await res.json();
        tbody.innerHTML='';
        if(Array.isArray(json.transactions)&&json.transactions.length){
          json.transactions.forEach((t,i)=>{
            const amt=Number(t.jumlah)||0;
            const isIncome=(t.jenis||'').toLowerCase().includes('pemasukan');
            const cls=isIncome?'text-success':'text-danger';
            const statusBadge=(t.status||'').toLowerCase().includes('lunas')
              ?`<span class="badge bg-success">Lunas</span>`
              :`<span class="badge bg-danger">${t.status||'—'}</span>`;
            tbody.innerHTML+=`
              <tr>
                <td>${i+1}</td>
                <td>${t.tanggal}</td>
                <td>${t.jenis}</td>
                <td>${t.deskripsi||'-'}</td>
                <td class="text-end ${cls}">${formatRupiah(amt)}</td>
                <td>${statusBadge}</td>
              </tr>`;
          });
        }else{
          tbody.innerHTML=`<tr><td colspan="6" class="text-center muted">Belum ada transaksi pada periode ini</td></tr>`;
        }
      }catch(err){
        console.error(err);
        tbody.innerHTML=`<tr><td colspan="6" class="text-center text-danger">Gagal memuat data.</td></tr>`;
      }
    }

    function exportCSV(){
      const rows=[['No','Tanggal','Jenis','Deskripsi','Jumlah','Status']];
      document.querySelectorAll('#tbodyTransaksi tr').forEach(tr=>{
        const cells=Array.from(tr.querySelectorAll('td')).map(td=>td.innerText.trim());
        if(cells.length)rows.push(cells);
      });
      const csv=rows.map(r=>r.map(c=>`"${c.replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;a.download=`transparansi_transaksi_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
    }

    loadData();
  </script>
</body>
</html>